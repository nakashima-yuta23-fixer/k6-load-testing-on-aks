# Terraform Module: networking_vnet

## Overview

This module provisions a foundational Azure Virtual Network (VNet) and a set of associated subnets.

It is designed to be highly flexible, allowing for the dynamic creation of any number of standard subnets, as well as special-purpose subnets required by Azure services (e.g., `AzureFirewallSubnet`, `GatewaySubnet`).

This module serves as the core networking foundation upon which other resources and solutions are built.

### Key Features

- **Dynamic Subnet Creation**: Define any number of subnets with custom address prefixes using a simple map variable.
- **Service Delegation Support**: Easily configure subnet delegation for services like Azure Container Apps via the `dynamic "delegation"` block.
- **Special Subnet Support**: Handles the creation of Azure-required subnets with fixed names.
- **Standardized Naming**: Generates compliant names for the VNet and all subnets using the central `utils/naming` module.

---

<!-- This section is automatically generated by terraform-docs. Do not edit it directly. -->
<!-- To update, run 'terraform-docs' in this directory. -->
<!-- BEGIN_TF_DOCS -->

## Requirements

| Name                                                                     | Version |
| ------------------------------------------------------------------------ | ------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | ~> 1.12 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement_azurerm)       | ~> 4.36 |

## Providers

| Name                                                         | Version |
| ------------------------------------------------------------ | ------- |
| <a name="provider_azurerm"></a> [azurerm](#provider_azurerm) | ~> 4.36 |

## Modules

| Name                                                                       | Source             | Version |
| -------------------------------------------------------------------------- | ------------------ | ------- |
| <a name="module_subnet_naming"></a> [subnet_naming](#module_subnet_naming) | ../../utils/naming | n/a     |
| <a name="module_vnet_naming"></a> [vnet_naming](#module_vnet_naming)       | ../../utils/naming | n/a     |

## Resources

| Name                                                                                                                            | Type     |
| ------------------------------------------------------------------------------------------------------------------------------- | -------- |
| [azurerm_subnet.azure_firewall](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet)         | resource |
| [azurerm_subnet.standard](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet)               | resource |
| [azurerm_subnet.vnet_gateway](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet)           | resource |
| [azurerm_virtual_network.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_network) | resource |

## Inputs

| Name                                                                                       | Description                                                                                                               | Type                                                                                                                                                                                                                                                                                                                                                               | Default                                                                | Required |
| ------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------- | :------: |
| <a name="input_customer_code"></a> [customer_code](#input_customer_code)                   | A short unique code for the customer or context. This value is passed to the naming module.                               | `string`                                                                                                                                                                                                                                                                                                                                                           | n/a                                                                    |   yes    |
| <a name="input_environment"></a> [environment](#input_environment)                         | The full name of the environment for this VNet. This value is passed to the naming module.                                | `string`                                                                                                                                                                                                                                                                                                                                                           | n/a                                                                    |   yes    |
| <a name="input_location"></a> [location](#input_location)                                  | The Azure location where the VNet will be created.                                                                        | `string`                                                                                                                                                                                                                                                                                                                                                           | n/a                                                                    |   yes    |
| <a name="input_resource_group_name"></a> [resource_group_name](#input_resource_group_name) | The name of the resource group where the VNet will be created.                                                            | `string`                                                                                                                                                                                                                                                                                                                                                           | n/a                                                                    |   yes    |
| <a name="input_role"></a> [role](#input_role)                                              | A short name describing the primary role of this VNet (e.g., hub, spoke, app). This value is passed to the naming module. | `string`                                                                                                                                                                                                                                                                                                                                                           | n/a                                                                    |   yes    |
| <a name="input_special_subnets"></a> [special_subnets](#input_special_subnets)             | Configuration for special, Azure-required subnets like AzureFirewallSubnet and GatewaySubnet.                             | <pre>object({<br> azure_firewall = optional(object({<br> address_prefix = string<br> }), null)<br> vnet_gateway = optional(object({<br> address_prefix = string<br> }), null)<br> })</pre>                                                                                                                                                                         | <pre>{<br> "azure_firewall": null,<br> "vnet_gateway": null<br>}</pre> |    no    |
| <a name="input_subnets"></a> [subnets](#input_subnets)                                     | A map of subnet objects to be created within the VNet. The key of the map is the short name for the subnet's role.        | <pre>map(object({<br> address_prefixes = list(string)<br> service_endpoints = optional(list(string), [])<br> private_endpoint_network_policies = optional(string, "Disabled")<br> delegation = optional(object({<br> name = string<br> service_delegation = object({<br> name = string<br> actions = optional(list(string), [])<br> })<br> }), null)<br> }))</pre> | `{}`                                                                   |    no    |
| <a name="input_vnet_address_space"></a> [vnet_address_space](#input_vnet_address_space)    | A list of CIDR blocks for the VNet (e.g., ["10.0.0.0/16"]).                                                               | `list(string)`                                                                                                                                                                                                                                                                                                                                                     | n/a                                                                    |   yes    |

## Outputs

| Name                                                                                      | Description                                                                          |
| ----------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ |
| <a name="output_special_subnet_ids"></a> [special_subnet_ids](#output_special_subnet_ids) | A map of IDs for special-purpose subnets like AzureFirewallSubnet and GatewaySubnet. |
| <a name="output_subnet_ids"></a> [subnet_ids](#output_subnet_ids)                         | A map of standard subnet IDs, keyed by their role name.                              |
| <a name="output_subnets"></a> [subnets](#output_subnets)                                  | A map of all standard subnets created by the module, keyed by their role name.       |
| <a name="output_vnet_address_space"></a> [vnet_address_space](#output_vnet_address_space) | The address space of the created Virtual Network.                                    |
| <a name="output_vnet_id"></a> [vnet_id](#output_vnet_id)                                  | The ID of the created Virtual Network.                                               |
| <a name="output_vnet_name"></a> [vnet_name](#output_vnet_name)                            | The name of the created Virtual Network.                                             |

<!-- END_TF_DOCS -->

---

## Usage

This module is typically called from a `solutions` module to create the primary network topology for an environment.

### Basic Example

This example creates a VNet with two standard subnets: one for applications and one for private endpoints.

```hcl
module "my_network" {
  source = "../../foundations/networking_vnet"

  # Naming and Location
  resource_group_name = "rg-my-app-networking"
  location            = "japaneast"
  customer_code       = "gaixer"
  role                = "primary"
  environment         = "development"

  # VNet Configuration
  vnet_address_space = ["10.10.0.0/16"]

  # Subnet Definitions
  subnets = {
    "app" = {
      address_prefixes = ["10.10.1.0/24"]
      # Delegation for Container Apps
      delegation = {
        name = "Microsoft.App.environments"
        service_delegation = {
          name = "Microsoft.App/environments"
        }
      }
    },
    "db-endpoints" = {
      address_prefixes                  = ["10.10.2.0/24"]
      private_endpoint_network_policies = "Enabled" # Example
    }
  }
}
```

## Examples

For fully functional, runnable examples demonstrating both simple and more complex configurations, please see the [`examples/`](./examples/) directory.

- **`simple/`**: A basic VNet with two subnets.
- **`full-featured/`**: A more complex VNet including special-purpose subnets like `GatewaySubnet`.
